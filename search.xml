<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>图床测试</title>
      <link href="/2020/07/31/%E5%9B%BE%E5%BA%8A%E6%B5%8B%E8%AF%95/"/>
      <url>/2020/07/31/%E5%9B%BE%E5%BA%8A%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h3 id="img-vim-cn-com-稳定性很好，但最好不要上传违法图片"><a href="#img-vim-cn-com-稳定性很好，但最好不要上传违法图片" class="headerlink" title="img.vim-cn.com 稳定性很好，但最好不要上传违法图片"></a><a href="https://img.vim-cn.com" target="_blank" rel="noopener">img.vim-cn.com</a> 稳定性很好，但最好不要上传违法图片</h3><blockquote><p>图片外链展示 图片上传日期：2019年12月28日</p></blockquote><p><img src="https://img.vim-cn.com/e2/2c1cc9083d70b4ea48822d1110722e7696d98a.jpg" alt="vim-cn图床已失效"></p><hr><h3 id="阿里"><a href="#阿里" class="headerlink" title="阿里"></a>阿里</h3><blockquote><p>图片外链展示 图片上传日期：2019年12月28日</p></blockquote><p><img src="https://ae01.alicdn.com/kf/U92b1a9831f7b43bfb71616712489e01a3.jpg" alt="阿里图床已失效"></p><hr><h3 id="掘金（需要处理防盗链）"><a href="#掘金（需要处理防盗链）" class="headerlink" title="掘金（需要处理防盗链）"></a>掘金（需要处理防盗链）</h3><blockquote><p>图片外链展示 图片上传日期：2019年12月28日</p></blockquote><p><img src="https://pic1.xuehuaimg.com/proxy/user-gold-cdn.xitu.io/2019/12/28/16f4aa297b8dd6e0" alt="掘金图床已失效"></p><hr><h3 id="牛图网"><a href="#牛图网" class="headerlink" title="牛图网"></a><a href="https://niupic.com" target="_blank" rel="noopener">牛图网</a></h3><blockquote><p>图片外链展示 图片上传日期：2019年12月28日</p></blockquote><p><img src="https://i.niupic.com/images/2019/12/28/6cmk.jpg" alt="牛图网图床已失效"></p><hr><h3 id="钉钉"><a href="#钉钉" class="headerlink" title="钉钉"></a>钉钉</h3><blockquote><p>图片外链展示 图片上传日期：2020年7月24日<br><img src="https://static.dingtalk.com/media/lADPDhYBNOkZB5zNCADNCAA_2048_2048.jpg" alt="钉钉图床已失效"></p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>解决win10输入法切换不出来</title>
      <link href="/2020/05/24/win10%E8%BE%93%E5%85%A5%E6%B3%95%E5%88%87%E6%8D%A2%E4%B8%8D%E5%87%BA%E6%9D%A5/"/>
      <url>/2020/05/24/win10%E8%BE%93%E5%85%A5%E6%B3%95%E5%88%87%E6%8D%A2%E4%B8%8D%E5%87%BA%E6%9D%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="问题描述："><a href="#问题描述：" class="headerlink" title="问题描述："></a>问题描述：</h1><p>win10输入法切换不出来，任务栏右下角也看不见语言栏</p><h1 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h1><p><code>win + R</code>输入<code>高级键盘设置</code> -&gt; 勾选<code>使用桌面语言栏(如果可用)</code>，如果已经勾选，则取消勾选后再次勾选。这样不出意外的话右下角语言栏就出现了。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>图片镜像缓存服务</title>
      <link href="/2020/05/18/%E5%9B%BE%E7%89%87%E9%95%9C%E5%83%8F%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1/"/>
      <url>/2020/05/18/%E5%9B%BE%E7%89%87%E9%95%9C%E5%83%8F%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文由 <a href="http://ksria.com/simpread/" target="_blank" rel="noopener">简悦 SimpRead</a> 转码， 原文地址 <a href="https://hao.su/2854/" target="_blank" rel="noopener">https://hao.su/2854/</a></p></blockquote><div class="content-hint hint-success"> <i class="content-hint-icon fa fa-check-circle"></i> 投稿：<a href="https://wj.qq.com/s2/5160416/31b6/" target="_blank" rel="noopener"> 提交 </a> </div><p>网络中收集的一些<strong>图片镜像缓存服务</strong>，在很多时候可以起到不错的用途。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;search.pstatic.net&#x2F;common?src&#x3D;</span><br><span class="line">https:&#x2F;&#x2F;imageproxy.pimg.tw&#x2F;resize?url&#x3D;</span><br><span class="line">https:&#x2F;&#x2F;images.weserv.nl&#x2F;?url&#x3D;</span><br><span class="line">https:&#x2F;&#x2F;pic1.xuehuaimg.com&#x2F;proxy&#x2F;</span><br></pre></td></tr></table></figure><blockquote><p>图像缓存可以用来做什么？</p></blockquote><ul><li>可以将有防盗链的图片引用到网页，并成功显示。</li><li>可以将 http 图片引用到 https 页面而不出现证书问题。</li><li>可以将 xxx 的图片，成功加载。</li><li>可以将比较慢的图片资源，加快显示。</li></ul><p>部分服务图片链接可以不添加 <code>http://</code> 或 <code>https://</code> 协议。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;imageproxy.pimg.tw&#x2F;resize?url&#x3D;https:&#x2F;&#x2F;i.imgur.com&#x2F;hWghm6oh.jpg</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;images.weserv.nl&#x2F;?url&#x3D;i.imgur.com&#x2F;hWghm6oh.jpg</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;pic1.xuehuaimg.com&#x2F;proxy&#x2F;i.imgur.com&#x2F;hWghm6oh.jpg</span><br></pre></td></tr></table></figure><p>首推 <code>images.weserv.nl</code> 该服务不仅可以作为一个图像缓存，还有多种参数可选，例如可以直接修改图片尺寸，旋转图片等操作。</p><ul><li>举例,尝试将一张图片等比例调整为宽500，如果源图片宽小于500，则不调整。<br><code>https://images.weserv.nl/?url=c-ssl.duitang.com/uploads/item/201607/02/20160702122710_iRUXT.thumb.300_0.jpeg&amp;w=500&amp;fit=inside&amp;we</code> </li></ul><blockquote><p>其它用法，可以参考：<a href="https://images.weserv.nl/" target="_blank" rel="noopener">https://images.weserv.nl</a></p></blockquote><h2 id="防盗链图片演示"><a href="#防盗链图片演示" class="headerlink" title="防盗链图片演示"></a>防盗链图片演示</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;pic1.zhimg.com&#x2F;v2-8b657dff159debf1cff463d61b7dcafd_r.jpg</span><br></pre></td></tr></table></figure><p><img src="https://pic1.xuehuaimg.com/proxy/pic1.zhimg.com/v2-8b657dff159debf1cff463d61b7dcafd_r.jpg" alt=""></p><p>该图片是知乎的图片，存在防盗链，在图片外链前面加上图片镜像服务后就可以正常显示了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;i.imgur.com&#x2F;hWghm6oh.jpg</span><br></pre></td></tr></table></figure><p>该图片是知名图床 <strong>imgur</strong> 的图片，至今已有 10 多年历史，由于上面不限制上传图片类型所以在中国无法打开，在图片外链前面加上图片镜像服务后就可以正常显示了。</p><p><img src="https://imageproxy.pimg.tw/resize?url=https://i.imgur.com/hWghm6oh.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 网络技巧 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 图片 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GitHub使用技巧</title>
      <link href="/2020/05/16/GitHub%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/"/>
      <url>/2020/05/16/GitHub%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/</url>
      
        <content type="html"><![CDATA[<h2 id="1-利用jsDelivrCDN提高GitHub仓库静态资源访问速度"><a href="#1-利用jsDelivrCDN提高GitHub仓库静态资源访问速度" class="headerlink" title="1.利用jsDelivrCDN提高GitHub仓库静态资源访问速度"></a>1.利用<code>jsDelivr</code>CDN提高<code>GitHub</code>仓库静态资源访问速度</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用方法</span></span><br><span class="line">https://cdn.jsdelivr.net/gh/user/repo@version/file</span><br><span class="line">https://cdn.jsdelivr.net/gh/user/repo/file</span><br></pre></td></tr></table></figure><p>例如一张图片，在<code>github</code>的地址是<a href="https://github.com/Nomeqc/static/blob/master/images/wallpaper/v2-6f197c9ade14af2213ece8baaed30435_r.jpg" target="_blank" rel="noopener">https://github.com/Nomeqc/static/blob/master/images/wallpaper/v2-6f197c9ade14af2213ece8baaed30435_r.jpg</a><br>现在，可以使用<code>jsdelivr</code>的CDN服务<a href="https://cdn.jsdelivr.net/gh/Nomeqc/static/images/wallpaper/v2-6f197c9ade14af2213ece8baaed30435_r.jpg" target="_blank" rel="noopener">https://cdn.jsdelivr.net/gh/Nomeqc/static/images/wallpaper/v2-6f197c9ade14af2213ece8baaed30435_r.jpg</a>来访问</p><h2 id="2-解决克隆仓库速度太慢"><a href="#2-解决克隆仓库速度太慢" class="headerlink" title="2. 解决克隆仓库速度太慢"></a>2. 解决克隆仓库速度太慢</h2><p>可以通过<a href="https://gitee.com/" target="_blank" rel="noopener">gitee</a>的仓库导入功能导入远程仓库。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>治愈系动图</title>
      <link href="/2020/05/14/%E4%B8%8B%E9%9B%A8%E6%84%8F%E5%A2%83%E6%B2%BB%E6%84%88%E5%8A%A8%E5%9B%BE/"/>
      <url>/2020/05/14/%E4%B8%8B%E9%9B%A8%E6%84%8F%E5%A2%83%E6%B2%BB%E6%84%88%E5%8A%A8%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<p><img src="https://ae01.alicdn.com/kf/U2246d68c94dc448ead5264a90076465fI.jpg" alt=""></p><hr><p><img src="https://ae01.alicdn.com/kf/Ufe5e214c4a1946fe94419be82e28aed68.jpg" alt=""></p><hr><p><img src="https://ae01.alicdn.com/kf/U93a062836db642449eb19cb1b5585d14D.jpg" alt=""></p><hr><p><img src="https://ae01.alicdn.com/kf/Uddc5e2b968844bb5bb2464c0b4f37233d.jpg" alt=""></p><hr><p><img src="https://ae01.alicdn.com/kf/Ua759d86634f54710bede135582a83c94b.jpg" alt=""></p><hr><p><img src="https://ae01.alicdn.com/kf/U591e262b7a224692a50d4e37d16352c5h.jpg" alt=""></p><hr><p><img src="https://ae01.alicdn.com/kf/Ubfc8ca9746894f3f87b999ff5583d1a24.jpg" alt=""></p><hr><p><img src="https://ae01.alicdn.com/kf/Uccf8997ed369490fafbbb14b1f89d673l.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 治愈 </tag>
            
            <tag> 动图 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WIN10全屏任务栏无法消失</title>
      <link href="/2020/05/12/WIN10%E5%85%A8%E5%B1%8F%E4%BB%BB%E5%8A%A1%E6%A0%8F%E6%97%A0%E6%B3%95%E6%B6%88%E5%A4%B1/"/>
      <url>/2020/05/12/WIN10%E5%85%A8%E5%B1%8F%E4%BB%BB%E5%8A%A1%E6%A0%8F%E6%97%A0%E6%B3%95%E6%B6%88%E5%A4%B1/</url>
      
        <content type="html"><![CDATA[<h1 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h1><ul><li><a href="https://jingyan.baidu.com/article/59703552d6a4978fc007409d.html" target="_blank" rel="noopener">WIN10全屏任务栏无法消失</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> win10 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>「Hexo Admin」Deploy报错</title>
      <link href="/2020/05/11/%E3%80%8CHexo%20Admin%E3%80%8DDeploy%E6%8A%A5%E9%94%99/"/>
      <url>/2020/05/11/%E3%80%8CHexo%20Admin%E3%80%8DDeploy%E6%8A%A5%E9%94%99/</url>
      
        <content type="html"><![CDATA[<h2 id="Hexo-Admin-Deploy报错："><a href="#Hexo-Admin-Deploy报错：" class="headerlink" title="Hexo Admin Deploy报错："></a><code>Hexo Admin</code> Deploy报错：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Run</span><br><span class="line"></span><br><span class="line">  git config --global user.email &quot;you@example.com&quot;</span><br><span class="line">  git config --global user.name &quot;Your Name&quot;</span><br><span class="line"></span><br><span class="line">to set your account&#39;s default identity.</span><br><span class="line">Omit --global to set the identity only in this repository.</span><br></pre></td></tr></table></figure><h2 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h2><p>进入到<code>blog/.deploy_git</code>目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config user.email <span class="string">"you@example.com"</span></span><br><span class="line">git config user.name <span class="string">"Your Name"</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CentOS7 升级 Openssl 并支持 HTTP2 · 手册</title>
      <link href="/2020/05/11/CentOS7-%E5%8D%87%E7%BA%A7-Openssl-%E5%B9%B6%E6%94%AF%E6%8C%81-HTTP2-%C2%B7-%E6%89%8B%E5%86%8C/"/>
      <url>/2020/05/11/CentOS7-%E5%8D%87%E7%BA%A7-Openssl-%E5%B9%B6%E6%94%AF%E6%8C%81-HTTP2-%C2%B7-%E6%89%8B%E5%86%8C/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文由 <a href="http://ksria.com/simpread/" target="_blank" rel="noopener">简悦 SimpRead</a> 转码， 原文地址 <a href="https://www.kanshouce.com/2017/08/05/openssl-upgrade/" target="_blank" rel="noopener">https://www.kanshouce.com/2017/08/05/openssl-upgrade/</a></p></blockquote><p>CentOS 7 默认带的 openssl 是 1.0.1 版本，开启 HTTP2 则必须升级 1.1 左右的版本。</p><p>本文仅适用 CentOS7</p><p>以下为升级全过程</p><p>查看当前 openssl 版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl version</span><br></pre></td></tr></table></figure><p>查看输出版本</p><p>前往 Openssl 官方<a href="https://www.openssl.org/source/" target="_blank" rel="noopener">（戳我）</a>查看最新的 openssl 版本，make 本文的时候最新版本为 1.1.0f</p><p>下载并解压</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cd &#x2F;home</span><br><span class="line"></span><br><span class="line">$ wget https:&#x2F;&#x2F;www.openssl.org&#x2F;source&#x2F;openssl-1.1.0f.tar.gz</span><br><span class="line"></span><br><span class="line">$ tar -zxvf openssl-1.1.0f.tar.gz</span><br><span class="line"></span><br><span class="line">$ cd openssl-1.1.0f</span><br></pre></td></tr></table></figure><p>动态编译 Openssl，并安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;config zlib-dynamic</span><br><span class="line"></span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>这里要注意，如果编译的时候增加了 <code>zlib-dynamic</code> 这个参数代表了动态编译，编译完成后，只需要执行下文中<code>#添加libssl.so.1.1</code>等两个步骤，因为 openssl 的执行目录和文件都已经就绪。</p><p>如果用默认的安装，那么此刻 openssl 默认被安装到了<code>/usr/local/</code>目录。</p><p>查看目前运行的 Openssl 目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ which openssl</span><br></pre></td></tr></table></figure><p>开始升级（如果动态编译，可以从<code>#添加libssl.so.1.1</code>开始）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#把旧版本的openssl备份一下，下面的目录即是上面用which查出来的目录，每个人的服务器配置不一样，请依照情况执行。</span><br><span class="line"></span><br><span class="line">$ mv &#x2F;usr&#x2F;bin&#x2F;openssl &#x2F;usr&#x2F;bin&#x2F;openssl.bak</span><br><span class="line"></span><br><span class="line">$ mv &#x2F;usr&#x2F;include&#x2F;openssl &#x2F;usr&#x2F;include&#x2F;openssl.bak</span><br><span class="line"></span><br><span class="line">#拷贝刚编译好的新版本的openssl-1.1.0f</span><br><span class="line"></span><br><span class="line">$ cp &#x2F;usr&#x2F;local&#x2F;bin&#x2F;openssl &#x2F;usr&#x2F;bin&#x2F;openssl</span><br><span class="line"></span><br><span class="line">$ cp -r &#x2F;usr&#x2F;local&#x2F;ssl &#x2F;usr&#x2F;include&#x2F;openssl</span><br><span class="line"></span><br><span class="line">#注意，1.1.0f版本 生成的文件的位置在&#x2F;usr&#x2F;local&#x2F;ssl</span><br><span class="line"></span><br><span class="line">#这里没有用ln软链的原因是因为如果使用ln可能在后续安装中造成其他软件的安装错误,比较常见的就是报[install_dev]错误</span><br><span class="line"></span><br><span class="line">#添加libssl.so.1.1</span><br><span class="line"></span><br><span class="line">$ cp &#x2F;usr&#x2F;local&#x2F;lib64&#x2F;libssl.so.1.1 &#x2F;usr&#x2F;lib64&#x2F;libssl.so.1.1</span><br><span class="line"></span><br><span class="line">$ cp &#x2F;usr&#x2F;local&#x2F;lib64&#x2F;libcrypto.so.1.1 &#x2F;usr&#x2F;lib64&#x2F;libcrypto.so.1.1</span><br><span class="line"></span><br><span class="line">#查看openssl版本</span><br><span class="line"></span><br><span class="line">$ openssl version</span><br><span class="line"></span><br><span class="line">#重新加载动态链接库，这步比较重要，特别是下一步要升级nginx</span><br><span class="line"></span><br><span class="line">$ ldconfig -v</span><br></pre></td></tr></table></figure><p>至此，openssl 已经成功升级。</p><h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><p>Nginx 的升级相对比较简单</p><p>升级前最好<code>检查</code>下是否具备编译 Nginx 的条件，特别是以前很多采用<code>YUM</code>安装的懒癌晚期，可能没安装编译环境：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install gcc-c ++ pcre-devel zlib-devel make wget openssl-devel libxml2-devel libxslt-devel gd-devel perl-ExtUtils-Embed GeoIP-devel gperftools-devel</span><br></pre></td></tr></table></figure><p>以上基本把所需的依赖都装好了，如果在下面的编译环境中提示<code>Peal</code>的相关错误，可以考虑安装<code>cpan</code>，用 cpan 按照提示安装缺少的 peal 库。</p><p>开始升级</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#看一下nginx版本与配置</span><br><span class="line"></span><br><span class="line">[root@sf3 ~]# nginx -V</span><br><span class="line"></span><br><span class="line">nginx version: nginx&#x2F;1.10.0   &#x2F;&#x2F;这里输出的是当前版本</span><br><span class="line"></span><br><span class="line">built by gcc 4.4.7 20120313 (Red Hat 4.4.7-17) (GCC) &#x2F;&#x2F;编译用的Gcc版本</span><br><span class="line"></span><br><span class="line">built with OpenSSL 1.0.1e-fips 11 Feb 2013  &#x2F;&#x2F;使用的openssl版本，我们本次升级主要针对的地方</span><br><span class="line"></span><br><span class="line">TLS SNI support enabled  &#x2F;&#x2F;TLS支持是否打开</span><br><span class="line"></span><br><span class="line">configure arguments: [内容略去]  &#x2F;&#x2F;编译参数</span><br></pre></td></tr></table></figure><p>最新稳定版本是 1.10.2</p><p>官网地址：<a href="http://nginx.org/" target="_blank" rel="noopener">http://nginx.org</a></p><p>升级步骤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#下载nginx最新版</span><br><span class="line"></span><br><span class="line">$ cd &#x2F;home</span><br><span class="line"></span><br><span class="line">$wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.10.2.tar.gz</span><br><span class="line"></span><br><span class="line">#解压源码</span><br><span class="line"></span><br><span class="line">$ tar zxvf nginx-1.10.2.tar.gz</span><br><span class="line"></span><br><span class="line">#进入源码目录</span><br><span class="line"></span><br><span class="line">$ cd nginx-1.10.2</span><br><span class="line"></span><br><span class="line">#加上所需参数开始编译</span><br><span class="line"></span><br><span class="line">$ .&#x2F;configure [这里copy上文提到的内容略去部分，或者根据你自己的情况进行配置] --with-openssl&#x3D;&#x2F;home&#x2F;openssl-1.1.0f #请注意，这条最重要，对应openssl源码解压后的路径</span><br><span class="line"></span><br><span class="line">#执行make编译，但是不要执行make install</span><br><span class="line"></span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line">#重命名nginx旧版本二进制文件，即sbin目录下的nginx（期间nginx并不会停止服务）</span><br><span class="line"></span><br><span class="line">#每个人服务器的安装不太一样，执行前记得用which nginx看一下nginx所在目录</span><br><span class="line"></span><br><span class="line">$ mv &#x2F;usr&#x2F;sbin&#x2F;nginx &#x2F;usr&#x2F;sbin&#x2F;nginx.old</span><br><span class="line"></span><br><span class="line">#然后拷贝一份新编译的二进制文件</span><br><span class="line"></span><br><span class="line">$ cp objs&#x2F;nginx &#x2F;usr&#x2F;sbin&#x2F;sbin&#x2F;</span><br><span class="line"></span><br><span class="line">#在源码目录执行make upgrade开始升级</span><br><span class="line"></span><br><span class="line">$ make upgrade</span><br><span class="line"></span><br><span class="line">#完成后查看下版本</span><br><span class="line"></span><br><span class="line">$ nginx -V</span><br></pre></td></tr></table></figure><p>如果遇到错误，请参考本博客<a href="https://www.kanshouce.com/2017/08/01/nginx-php7/" target="_blank" rel="noopener">上篇文章</a>，用 YUM 升级安装 nginx 到最新版本 nginx，再进行编译。</p><h2 id="配置部分"><a href="#配置部分" class="headerlink" title="配置部分"></a>配置部分</h2><p>在 nginx 的<code>conf</code>文件里，对对应的站点进行配置，非常简单，只需要增加<code>ssl http2;</code>即可，比如说：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen 443 ssl http2 default_server;</span><br></pre></td></tr></table></figure><p>要验证 http2 是否生效可以安装个 chrome 插件<code>HTTP/2 and SPDY indicator</code>，如果开启了 h2，那么会有一道蓝色的闪电，比如说，就像本站已经开启了：<br><img src="https://pic.kanshouce.com/blog/2017-08-06-2017-08-06%205.18.06.png" alt=""></p><h3 id="推荐的配置"><a href="#推荐的配置" class="headerlink" title="推荐的配置"></a>推荐的配置</h3><p>这里有个网站推荐给大家，可以生成被优化推荐的 Nginx 配置文件</p><p><a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/" target="_blank" rel="noopener">戳我抵达</a></p><p>除了上面提到的 Chrome 插件以外，如果服务器的 openssl 版本过低，可能导致 chrom 浏览器访问失败，原因是因为在去年 google chrom51 版本中 google 移除了 NPN，只支持 ALPN，所以导致协商失败。</p><p>用这条命令可以测试目前 HTTP2 服务是否支持 ALPN</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -alpn h2 -servername imququ.com -connect kanshouce.com:443 &lt; &#x2F;dev&#x2F;null | grep &#39;ALPN&#39;</span><br></pre></td></tr></table></figure><p>如果提示 <code>unknown option -alpn</code>，说明本地的 OpenSSL 版本太低（可通过 <code>openssl version</code> 查看），请升级到 1.0.2+。如果不方便升级，也可以使用 <a href="https://www.ssllabs.com/ssltest/index.html" target="_blank" rel="noopener">Qualys SSL Labs’s SSL Server Test</a> 这个在线工具来测试。</p><p>如果结果包含 <code>ALPN protocol: h2</code>，说明服务端支持 ALPN，不受 Chrome 51+ 去掉 NPN 的影响。</p><p>如果结果包含 <code>No ALPN negotiated</code>，说明服务端不支持 ALPN，在 Chrome 51+ 中无法协商到 HTTP/2，需要尽快升级。</p>]]></content>
      
      
      
        <tags>
            
            <tag> centos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 acme.sh 在单台 Linux / Windows 服务器或者集群上自动化申请和更新 https 证书</title>
      <link href="/2020/03/13/%E4%BD%BF%E7%94%A8%20acme.sh%20%E5%9C%A8%E5%8D%95%E5%8F%B0%20Linux%20_%20Windows%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%88%96%E8%80%85%E9%9B%86%E7%BE%A4%E4%B8%8A%E8%87%AA%E5%8A%A8%E5%8C%96%E7%94%B3%E8%AF%B7%E5%92%8C%E6%9B%B4%E6%96%B0%20https%20%E8%AF%81%E4%B9%A6%20_%20CCIE%20%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%A4%BE%E5%8C%BA%20(2020-03-13%20%E4%B8%8B%E5%8D%882_49_43)/"/>
      <url>/2020/03/13/%E4%BD%BF%E7%94%A8%20acme.sh%20%E5%9C%A8%E5%8D%95%E5%8F%B0%20Linux%20_%20Windows%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%88%96%E8%80%85%E9%9B%86%E7%BE%A4%E4%B8%8A%E8%87%AA%E5%8A%A8%E5%8C%96%E7%94%B3%E8%AF%B7%E5%92%8C%E6%9B%B4%E6%96%B0%20https%20%E8%AF%81%E4%B9%A6%20_%20CCIE%20%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%A4%BE%E5%8C%BA%20(2020-03-13%20%E4%B8%8B%E5%8D%882_49_43)/</url>
      
        <content type="html"><![CDATA[> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [ccie.lol](https://ccie.lol/knowledge-base/linux-centos-use-acme-sh/)acme.sh 是一个自动化申请和更新 https 证书的脚本，非常地好用；但在使用过程中也发现了一些不足，Ricky 在此提供一个解决方案。### **什么是 acme.sh ？**acme.sh 实现了 acme 协议，可以从 letsencrypt 生成免费的证书，详情请看 acme.sh 在 [github 上的首页](https://github.com/Neilpang/acme.sh)和 [github 上的中文介绍](https://github.com/Neilpang/acme.sh/wiki/%E8%AF%B4%E6%98%8E)。### **如何安装和使用 acme.sh ？**如果您看 [github 上的中文介绍](https://github.com/Neilpang/acme.sh/wiki/%E8%AF%B4%E6%98%8E)您也能了解这部分的内容，但我这里会说一些 github 上所没有提及的（比如安装失败提示 Download error 时该如何解决）。#### **1 、安装 acme.sh（以 CentOS Linux 6 / 7 为例）：**安装 acme.sh 的命令只有一条：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl  https:&#x2F;&#x2F;get.acme.sh | sh</span><br></pre></td></tr></table></figure>但 Ricky 建议您这么安装：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# yum -y install nss</span><br><span class="line">[root@host ~]# yum -y update nss</span><br><span class="line">[root@host ~]# curl  https:&#x2F;&#x2F;get.acme.sh | sh</span><br><span class="line">[root@host ~]# &#x2F;root&#x2F;.acme.sh&#x2F;acme.sh  --upgrade  --auto-upgrade</span><br></pre></td></tr></table></figure>（ 1 ）执行 /root/.acme.sh/acme.sh –upgrade –auto-upgrade 的目的是开启 acme.sh 的自动更新。目前由于 acme 协议和 letsencrypt CA 都在频繁的更新，因此 acme.sh 也需要经常更新以保持同步。（ 2 ）对于一些版本比较旧的 CentOS Linux（如 CentOS Linux 6.2 ）而言，如果不升级 nss 这个包，在安装 acme.sh 时可能会报以下 Download error 的错误：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl  https:&#x2F;&#x2F;get.acme.sh | sh</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   705  100   705    0     0    355      0  0:00:01  0:00:01 --:--:--  2357</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  164k  100  164k    0     0  31028      0  0:00:05  0:00:05 --:--:-- 69529</span><br><span class="line">[Thu Nov  8 21:52:26 CST 2018] Installing from online archive.</span><br><span class="line">[Thu Nov  8 21:52:26 CST 2018] Downloading https:&#x2F;&#x2F;github.com&#x2F;Neilpang&#x2F;acme.sh&#x2F;archive&#x2F;master.tar.gz</span><br><span class="line">[Thu Nov  8 21:52:27 CST 2018] Please refer to https:&#x2F;&#x2F;curl.haxx.se&#x2F;libcurl&#x2F;c&#x2F;libcurl-errors.html for error code: 35</span><br><span class="line">[Thu Nov  8 21:52:27 CST 2018] Download error.</span><br><span class="line">[root@host ~]#</span><br></pre></td></tr></table></figure>执行 yum -y install nss 和 yum -y update nss 后上述问题即可解决，再次安装 acme.sh 就不会报错了：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl  https:&#x2F;&#x2F;get.acme.sh | sh</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   705  100   705    0     0    227      0  0:00:03  0:00:03 --:--:--  2365</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  164k  100  164k    0     0   4887      0  0:00:34  0:00:34 --:--:-- 15699</span><br><span class="line">[Thu Nov  8 21:55:02 CST 2018] Installing from online archive.</span><br><span class="line">[Thu Nov  8 21:55:02 CST 2018] Downloading https:&#x2F;&#x2F;github.com&#x2F;Neilpang&#x2F;acme.sh&#x2F;archive&#x2F;master.tar.gz</span><br><span class="line">[Thu Nov  8 21:55:04 CST 2018] Extracting master.tar.gz</span><br><span class="line">[Thu Nov  8 21:55:06 CST 2018] It is recommended to install socat first.</span><br><span class="line">[Thu Nov  8 21:55:06 CST 2018] We use socat for standalone server if you use standalone mode.</span><br><span class="line">[Thu Nov  8 21:55:06 CST 2018] If you don&#39;t use standalone mode, just ignore this warning.</span><br><span class="line">[Thu Nov  8 21:55:06 CST 2018] Installing to &#x2F;root&#x2F;.acme.sh</span><br><span class="line">[Thu Nov  8 21:55:06 CST 2018] Installed to &#x2F;root&#x2F;.acme.sh&#x2F;acme.sh</span><br><span class="line">[Thu Nov  8 21:55:06 CST 2018] Installing alias to &#39;&#x2F;root&#x2F;.bashrc&#39;</span><br><span class="line">[Thu Nov  8 21:55:06 CST 2018] OK, Close and reopen your terminal to start using acme.sh</span><br><span class="line">[Thu Nov  8 21:55:06 CST 2018] Installing alias to &#39;&#x2F;root&#x2F;.cshrc&#39;</span><br><span class="line">[Thu Nov  8 21:55:07 CST 2018] Installing alias to &#39;&#x2F;root&#x2F;.tcshrc&#39;</span><br><span class="line">[Thu Nov  8 21:55:07 CST 2018] Installing cron job</span><br><span class="line">[Thu Nov  8 21:55:07 CST 2018] Good, bash is found, so change the shebang to use bash as preferred.</span><br><span class="line">[Thu Nov  8 21:55:10 CST 2018] OK</span><br><span class="line">[Thu Nov  8 21:55:10 CST 2018] Install success!</span><br><span class="line">[root@host ~]#</span><br></pre></td></tr></table></figure>安装成功后，在 crontab -l 里您能看到如下任务计划（以下任务计划每天凌晨 0 点 31 分执行一次，相关 crontab 操作请[点击这里](https://ccie.lol/knowledge-base/linux-centos-crontab-configuration/)）：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">31 0 * * * &quot;&#x2F;root&#x2F;.acme.sh&quot;&#x2F;acme.sh --cron --home &quot;&#x2F;root&#x2F;.acme.sh&quot; &gt; &#x2F;dev&#x2F;null</span><br></pre></td></tr></table></figure>github 上还列举了几种安装方式，详情请[点击这里](https://github.com/Neilpang/acme.sh/wiki/How-to-install)。#### **2 、生成证书：**生成证书最重要的一步就是要验证域名的所有权（验证这个域名到底是不是您的，不然任何人都可以去生成 www.baidu.com 、www.taobao.com 和 www.qq.com 这些网站的证书来做钓鱼网站了），验证域名的所有权主要有两种方式：（ 1 ）通过 DNS 来验证（在 DNS 解析里添加一条 TXT 记录，第三方验证服务器会去查询这条 TXT 记录是否存在），在 DNS 解析里添加一条 TXT 记录又分为手动和自动两种：*   允许 acme.sh 使用域名解析商提供的 API 自动添加 TXT 记录（不一定支持所有域名解析商的 API ，也不是所有的域名解析商都有相关 API ）；*   手工添加 TXT 记录（麻烦，达不到自动化运维的要求）。（ 2 ）在代码目录里放置一个验证文件（第三方验证服务器会通过 http 的方式来访问您的代码目录，看其中是否有这个验证文件）。综上所述，“在代码目录里放置一个验证文件” 这种验证方式是最方便的，这种方式生成证书的命令如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# &#x2F;root&#x2F;.acme.sh&#x2F;acme.sh --issue -d mydomain.com -d www.mydomain.com --webroot &#x2F;home&#x2F;wwwroot&#x2F;mydomain.com&#x2F;</span><br></pre></td></tr></table></figure>或者：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# &#x2F;root&#x2F;.acme.sh&#x2F;acme.sh --issue -d www.mydomain.com --webroot &#x2F;home&#x2F;wwwroot&#x2F;mydomain.com&#x2F;</span><br></pre></td></tr></table></figure>其中：*   mydomain.com 和 www.mydomain.com 是您的域名；*   /home/wwwroot/mydomain.com/ 是您网站的代码根目录。只需要指定域名，并指定域名所在的网站根目录，acme.sh 就会全自动地生成验证文件，并放到网站的根目录，然后自动完成验证，最后会聪明地删除验证文件，整个过程没有任何副作用。验证完成后，证书就会签发下来了，但此时还需要执行一个安装证书的命令。#### **3 、安装证书：**前面证书生成以后，接下来需要把证书 copy 到真正需要用它的地方。注意，默认生成的证书都放在安装目录下：~/.acme.sh/ ，请不要直接使用此目录下的文件，例如：不要直接让 Nginx / Apache 的配置文件使用这下面的文件，这里面的文件都是内部使用，而且目录结构可能会变化。正确的使用方法是使用 –installcert 命令来安装证书，并指定目标位置，然后证书文件会被 copy 到相应的位置，例如：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# &#x2F;root&#x2F;.acme.sh&#x2F;acme.sh  --installcert  -d  www.mydomain.com   \</span><br><span class="line">               --key-file   &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;cert&#x2F;www.mydomain.com.key \</span><br><span class="line">               --fullchain-file &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;cert&#x2F;www.mydomain.com.pem \</span><br><span class="line">               --reloadcmd  &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload&quot;</span><br></pre></td></tr></table></figure>经实践证明，使用命令 /usr/local/nginx/sbin/nginx -s reload 是可以让 Nginx 重新加载新的证书的（实验的 Nginx 版本号为 1.15.6 ，当前最新版本）。如果您是想让 Nginx 多监听一个 443 端口，那我建议您先关闭 Nginx 的进程后再开启（相关 Nginx 的操作请[点击这里](https://ccie.lol/knowledge-base/linux-centos-install-nginx/)）。Nginx 上有关于 https 和 443 端口的配置我建议您手工配置即可（今后 acme.sh 会自动更新证书文件并重新加载 Nginx ）。#### **4 、更新证书：**目前证书在 60 天以后会自动更新，您无需任何操作（还记得上文中提到的 crontab -l 里的任务计划么？）。今后有可能会缩短这个时间，不过都是自动的，您不用关心。#### **5 、删除证书：**执行以下删除命令，再删除掉相关文件夹即可：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# &#x2F;root&#x2F;.acme.sh&#x2F;acme.sh --remove -d www.mydomain.com</span><br><span class="line">[root@host ~]# rm -rf &#x2F;root&#x2F;.acme.sh&#x2F;www.mydomain.com</span><br></pre></td></tr></table></figure>### **在使用过程中 Ricky 遇到的问题：**首先非常感谢您能耐心地看到这里，接下来才是本文的重点。在使用 acme.sh 时，虽然 “在代码目录里放置一个验证文件” 这种验证方式是最方便的，但是相比于 “ 通过 DNS 来验证 ” 的验证方式来说它有一个明显的缺点 —— 不支持集群。假设您有一个域名是 www.mydomain.com ，这个域名会首先解析到 1.1.1.1 这个 IP 地址上，而 1.1.1.1 实际上是一台负载均衡设备（比如 A10 、F5 或者 [HAProxy](https://ccie.lol/knowledge-base/linux-centos-install-haproxy/) ），负载均衡设备再往后才是两台 Web 服务器 2.2.2.2 和 3.3.3.3（ 如 Tomcat 或者 PHP 等 ）。如果您在 2.2.2.2 和 3.3.3.3 上均安装了 acme.sh 并分别执行了 “在代码目录里放置一个验证文件” 这种验证方式的生成证书的命令，那么这个时候会发生什么呢？假设 2.2.2.2 上的 acme.sh 生成的验证文件是 123 ，而 3.3.3.3 上的 acme.sh 生成的验证文件是 456 ，当第三方验证服务器通过 http 的方式来访问您的验证文件 123 时，负载均衡设备可能会将此次请求转给 3.3.3.3 ，那么此时验证失败 ……所以在使用集群的时候反而是 “通过 DNS 来验证” 会更方便一点。但如果我的域名解析商没有提供相关的 DNS API ，我也不想手工添加 TXT 记录，而我同时还用着集群，就没有解决方法了吗？有的。通过观察发现，acme.sh 会在您代码目录的 /.well-known/acme-challenge/ 文件夹下放置验证文件，那么我们可以通过反向代理来完成验证，比如：1.  我们专门创建一台安装有 acme.sh 的服务器 4.4.4.4 ，然后让所有 http://www.mydomain.com/.well-known/acme-challenge/xxxx 的 http 请求都转到 4.4.4.4 这台服务器上；2.  此时证书会生成到 4.4.4.4 这台服务器上，我们再在 2.2.2.2 和 3.3.3.3 上放置一个 Linux Shell 脚本，该脚本会自动去 4.4.4.4 上下载证书、自动跟现有的证书进行 MD5 比对，如果发现证书文件已经更新则自动 reload Nginx 即可。#### **详细步骤如下：**##### **1 、专门创建一台服务器 4.4.4.4 ，安装好  acme.sh 。**##### **2 、在 4.4.4.4 上安装一个 Nginx ，并配置以下 server 域：**<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       8081;</span><br><span class="line">    server_name  4.4.4.4;</span><br><span class="line">    root &#x2F;www&#x2F;ssl&#x2F;;    # 记得创建该文件夹，4.4.4.4 的证书会存储在这里</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>这么做的目的是为了能让 2.2.2.2 和 3.3.3.3 来 4.4.4.4 下载证书。从安全的角度出发，您不应该将该 8081 端口公开到互联网上（防止证书被别人下走），应该使用防火墙对该端口做一个基于源 IP 地址的限制，仅允许 2.2.2.2 和 3.3.3.3 来访问该端口（如果服务器均处于内网则可忽略）：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 2.2.2.2 -p tcp --dport 8081 -j ACCEPT</span><br><span class="line">iptables -A INPUT -s 3.3.3.3 -p tcp --dport 8081 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 8081 -j DROP</span><br></pre></td></tr></table></figure>建议：1.  如果您有自己的运维平台的话，可以自动获得所有服务器的 IP 地址，然后定时对该服务器的防火墙配置进行刷新即可。2.  建议在 8081 端口使用 https 协议，而不是 http 协议。##### **3 、配置反向代理：****（ 1 ）如果您的负载均衡设备 1.1.1.1 具有反向代理的功能，那么可以在负载均衡设备上配置，以 HAProxy 为例：**<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">acl dns_check path_reg -i ^&#x2F;.well-known&#x2F;acme-challenge&#x2F;</span><br><span class="line">use_backend dns_check_backend if dns_check</span><br><span class="line"></span><br><span class="line">backend dns_check_backend</span><br><span class="line">        mode    http</span><br><span class="line">        reqideny      ^[^:\ ]*\ .*&#x2F;(root\.exe\?|cmd\.exe\?|default\.ida\?)</span><br><span class="line">        balance roundrobin</span><br><span class="line">        server local 4.4.4.4:8081 maxconn 30000 check</span><br><span class="line"></span><br><span class="line">        contimeout     10000</span><br><span class="line">        srvtimeout      5000</span><br><span class="line">        fullconn 99999</span><br><span class="line">        redispatch</span><br><span class="line">        retries 3</span><br><span class="line"></span><br><span class="line">        option forwardfor</span><br><span class="line">        option httpclose</span><br></pre></td></tr></table></figure>**（ 2 ）如果您的负载均衡设备不支持反向代理，那么可以在 2.2.2.2 和 3.3.3.3 上安装一个 Nginx ，然后这么配置：**<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  _;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    location ~ &quot;&#x2F;.well-known&#x2F;acme-challenge&#x2F;&quot; &#123;</span><br><span class="line">       proxy_pass http:&#x2F;&#x2F;4.4.4.4:8081;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>**（ 3 ）如果 2.2.2.2 和 3.3.3.3 是 Windows 服务器，且使用的是 Apache ，那需要这么配置：**首先需要加载三个 Apache 的模块（在 Apache 的配置文件 httpd.conf 中，将下述三行前面的 # 号删除掉即可）：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LoadModule proxy_module modules&#x2F;mod_proxy.so</span><br><span class="line">LoadModule proxy_http_module modules&#x2F;mod_proxy_http.so</span><br><span class="line">LoadModule proxy_connect_module modules&#x2F;mod_proxy_connect.so</span><br></pre></td></tr></table></figure>mod_proxy_connect.so 模块是用于 https 协议的，如果您需要反向代理到使用 https 协议的网站（如：https://acme-server.com:8081/ ），不加载这个模块的话，Apache 的反向代理是不生效的（别问我为什么知道，Ricky 本人亲自踩过这个坑）。然后在 Apache 的配置文件 httpd.conf 中，添加如下配置即可：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule proxy_module&gt;</span><br><span class="line">&lt;IfModule proxy_http_module&gt;</span><br><span class="line">&lt;IfModule proxy_connect_module&gt;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Reverse Proxy</span><br><span class="line">#</span><br><span class="line">SSLProxyEngine on</span><br><span class="line">ProxyPass &quot;&#x2F;.well-known&#x2F;acme-challenge&#x2F;&quot; &quot;http:&#x2F;&#x2F;4.4.4.4:8081&#x2F;.well-known&#x2F;acme-challenge&#x2F;&quot;</span><br><span class="line">ProxyPassReverse &quot;&#x2F;.well-known&#x2F;acme-challenge&#x2F;&quot; &quot;http:&#x2F;&#x2F;4.4.4.4:8081&#x2F;.well-known&#x2F;acme-challenge&#x2F;&quot;</span><br><span class="line"></span><br><span class="line">ProxyRequests Off</span><br><span class="line"></span><br><span class="line">&lt;Proxy *&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">&lt;&#x2F;Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;IfModule&gt;</span><br><span class="line">&lt;&#x2F;IfModule&gt;</span><br><span class="line">&lt;&#x2F;IfModule&gt;</span><br></pre></td></tr></table></figure>这样，所有 http://www.mydomain.com/.well-known/acme-challenge/xxxx 的 http 请求都转到 4.4.4.4 这台服务器上了。##### **4 、在 4.4.4.4 上生成和安装证书：**请使用如下生成证书的命令：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# &#x2F;root&#x2F;.acme.sh&#x2F;acme.sh  --issue  -d www.mydomain.com  --webroot &#x2F;www&#x2F;ssl&#x2F;</span><br></pre></td></tr></table></figure>请使用如下安装证书的命令：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# &#x2F;root&#x2F;.acme.sh&#x2F;acme.sh  --installcert  -d  www.mydomain.com   \</span><br><span class="line">               --key-file   &#x2F;www&#x2F;ssl&#x2F;www.mydomain.com.key \</span><br><span class="line">               --fullchain-file &#x2F;www&#x2F;ssl&#x2F;www.mydomain.com.pem \</span><br><span class="line">               --reloadcmd  &quot;echo $THREE_LEVEL_DOMAIN - cert update . &gt;&gt; &#x2F;www&#x2F;ssl&#x2F;log&#x2F;cert.log&quot;</span><br></pre></td></tr></table></figure>这样，证书就会被安装到 /www/ssl/ 目录，方便 2.2.2.2 和 3.3.3.3 前来下载证书，同时 reloadcmd 命令也被设置成一个往 /www/ssl/log/cert.log 文件写入日志的命令。##### **5 、在 2.2.2.2 和 3.3.3.3 上使用脚本来定时更新证书并重新加载服务：****（ 1 ）如果证书需要配置在 CentOS Linux 服务器上，则使用 Linux Shell 脚本来定时更新证书并重新加载服务：**假设您是将证书配置在 2.2.2.2 和 3.3.3.3 的 Nginx 上的，那么我们需要将证书下载到 2.2.2.2 和 3.3.3.3 上，同时今后证书还能自动更新，并自动重新加载 Nginx（即使用一个 Linux Shell 脚本来实现）。2.2.2.2 和 3.3.3.3 的 Nginx 上如何配置证书呢？请看文章《 [CentOS Linux 6 / 7 编译安装 Nginx](https://ccie.lol/knowledge-base/linux-centos-install-nginx/) 》的 “2、修改 Nginx 的配置文件，让其支持 https” 部分。如果 1.1.1.1 使用的是 HAProxy ，那么在 HAProxy 上配置证书也是可以的，请看文章《 [CentOS Linux 6 / 7 编译安装 HAProxy](https://ccie.lol/knowledge-base/linux-centos-install-haproxy/) 》的 “1 、修改 HAProxy 的配置文件，让其支持 https” 部分。同时，如下脚本需要进行相应的修改。编写脚本，在命令行界面输入：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vi &#x2F;root&#x2F;update_cert.sh</span><br></pre></td></tr></table></figure>键入小写字母 i ，进入编辑模式，将以下脚本复制粘贴进去（请根据实际需要进行相应地修改）：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">if [ ! -f &quot;update_cert.list&quot; ] ; then</span><br><span class="line">        echo update_cert.list not found !</span><br><span class="line">        exit</span><br><span class="line">fi</span><br><span class="line">cert_of_list&#x3D;&#96;cat update_cert.list&#96;</span><br><span class="line"></span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;cert&#x2F;</span><br><span class="line">is_reload&#x3D;&quot;false&quot;</span><br><span class="line"></span><br><span class="line">for cert in $cert_of_list ; do</span><br><span class="line">        wget http:&#x2F;&#x2F;4.4.4.4:8081&#x2F;$cert.pem -O $cert.pem.new </span><br><span class="line">        wget http:&#x2F;&#x2F;4.4.4.4:8081&#x2F;$cert.key -O $cert.key.new</span><br><span class="line"></span><br><span class="line">        if [ -s &quot;$cert.pem.new&quot; -a -s &quot;$cert.key.new&quot; ] ; then</span><br><span class="line"></span><br><span class="line">                if [ -f &quot;$cert.pem&quot; -a -f &quot;$cert.key&quot; ] ; then</span><br><span class="line"></span><br><span class="line">                        pem_file_old&#x3D;&#96;md5sum $cert.pem | awk -F &#39; &#39; &#39;&#123;print $1&#125;&#39;&#96;</span><br><span class="line">                        pem_file_new&#x3D;&#96;md5sum $cert.pem.new | awk -F &#39; &#39; &#39;&#123;print $1&#125;&#39;&#96;</span><br><span class="line"></span><br><span class="line">                        key_file_old&#x3D;&#96;md5sum $cert.key | awk -F &#39; &#39; &#39;&#123;print $1&#125;&#39;&#96;</span><br><span class="line">                        key_file_new&#x3D;&#96;md5sum $cert.key.new | awk -F &#39; &#39; &#39;&#123;print $1&#125;&#39;&#96;</span><br><span class="line"></span><br><span class="line">                        if [ &quot;$pem_file_old&quot; !&#x3D; &quot;$pem_file_new&quot; -o &quot;$key_file_old&quot; !&#x3D; &quot;$key_file_new&quot; ] ; then</span><br><span class="line">                                mv -f $cert.pem.new $cert.pem</span><br><span class="line">                                mv -f $cert.key.new $cert.key</span><br><span class="line"></span><br><span class="line">                                is_reload&#x3D;&quot;true&quot;</span><br><span class="line"></span><br><span class="line">                                echo $(date &quot;+%F %H:%M&quot;) - $cert changed ! &gt;&gt; &#x2F;root&#x2F;update_cert.log</span><br><span class="line">                        else</span><br><span class="line">                                rm -f $cert.pem.new $cert.key.new</span><br><span class="line"></span><br><span class="line">                                #echo</span><br><span class="line">                                #echo pem_file_old&#x3D;$pem_file_old , pem_file_new&#x3D;$pem_file_new</span><br><span class="line">                                #echo key_file_old&#x3D;$key_file_old , key_file_new&#x3D;$key_file_new</span><br><span class="line">                                echo $(date &quot;+%F %H:%M&quot;) - $cert no changed . &gt;&gt; &#x2F;root&#x2F;update_cert.log</span><br><span class="line">                        fi</span><br><span class="line">                else</span><br><span class="line">                        mv -f $cert.pem.new $cert.pem</span><br><span class="line">                        mv -f $cert.key.new $cert.key</span><br><span class="line"></span><br><span class="line">                        echo $(date &quot;+%F %H:%M&quot;) - $cert new cert ! &gt;&gt; &#x2F;root&#x2F;update_cert.log</span><br><span class="line">                fi</span><br><span class="line">        else</span><br><span class="line">                echo $(date &quot;+%F %H:%M&quot;) - $cert download error ! &gt;&gt; &#x2F;root&#x2F;update_cert.log</span><br><span class="line">        fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [ &quot;$is_reload&quot; &#x3D;&#x3D; &quot;true&quot; ] ; then</span><br><span class="line">        &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload</span><br><span class="line">        echo $(date &quot;+%F %H:%M&quot;) - nginx reloaded ! &gt;&gt; &#x2F;root&#x2F;update_cert.log</span><br><span class="line">else</span><br><span class="line">        echo $(date &quot;+%F %H:%M&quot;) - nginx not reloaded . &gt;&gt; &#x2F;root&#x2F;update_cert.log</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>按一次 ESC 键退出编辑模式，然后键入 “:wq” 保存并退出。其中：1.  update_cert.list 是配置文件，里面存放的是要更新证书的域名的名称（一个域名一行）；这里用的是相对路径，所以该文件和 Linux Shell 脚本处在同一个目录下；请执行以下命令来写入配置：        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# echo &quot;www.mydomain.com&quot; &gt; &#x2F;root&#x2F;update_cert.list</span><br></pre></td></tr></table></figure>    2.  update_cert.log 是日志文件；这里用的是相对路径，所以该文件和 Linux Shell 脚本处在同一个目录下。3.  /usr/local/nginx/conf/cert/ 是存放证书的目录，这里用的是绝对路径。4.  /usr/local/nginx/sbin/nginx -s reload 是重新加载 Nginx 的命令，这个命令只是重新加载配置文件，不重启进程；如果证书是配置在 HAProxy 上的，那么这里需要改成重新加载 HAProxy 的命令。5.  请注意上述脚本中的 is_reload 变量是在什么时候才等于 true 的，请根据实际需要进行相应地修改。**（ 2 ）如果证书需要配置在 Windows 服务器上，则使用 Python 脚本来定时更新证书并重新加载服务：**Windows 服务器自然是无法使用 Linux Shell 脚本的，但 Linux 服务器可以使用 Python 脚本，那为什么 Linux 服务器不使用 Python 脚本呢？这纯属个人爱好问题，因为 Ricky 觉得没必要，毕竟 Linux 服务器下的 Linux Shell 脚本挺好用的。如果您喜欢，也可以在 Windows 服务器上使用 BAT 批处理脚本而不是 Python 脚本。要想在 Windows 中使用 Python 脚本，自然需要先安装 [Python](https://python.org/) ，安装 Python 的过程这里就忽略了。Python 脚本代码如下所示（脚本文件名为：update_cert.pyw ）：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: UTF-8 -*-</span><br><span class="line">from pathlib import Path as __path</span><br><span class="line">from os import rename, remove, popen</span><br><span class="line">from hashlib import md5 as __md5</span><br><span class="line">from urllib.request import urlretrieve</span><br><span class="line">from urllib.error import HTTPError</span><br><span class="line">from time import strftime, localtime</span><br><span class="line"></span><br><span class="line">list_filename &#x3D; &#39;update_cert.list&#39;</span><br><span class="line">log_filename &#x3D; &#39;update_cert.log&#39;</span><br><span class="line">url &#x3D; r&#39;http:&#x2F;&#x2F;4.4.4.4:8081&#x2F;%s.%s&#39;</span><br><span class="line">cert_dir &#x3D; r&#39;cert&#39;</span><br><span class="line">restart_server_cmd &#x3D; r&#39;C:\xampp\apache\bin\httpd -k restart&#39;</span><br><span class="line"></span><br><span class="line">cert_filename_template &#x3D; cert_dir + r&#39;\%s.%s&#39;</span><br><span class="line">log_file &#x3D; None</span><br><span class="line"></span><br><span class="line">def log_file_write(record):</span><br><span class="line">    global log_file</span><br><span class="line">    if log_file &#x3D;&#x3D; None or log_file.closed or &#39;a&#39; not in log_file.mode:</span><br><span class="line">        log_file &#x3D; open(log_filename, &#39;a&#39;)</span><br><span class="line">    log_file.write(&#39;%s - %s\n&#39; % (strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, localtime()), record))</span><br><span class="line">    log_file.flush()</span><br><span class="line"></span><br><span class="line">def md5sum(filename):</span><br><span class="line">    if not __path(filename).is_file():  return &#39;0&#39;</span><br><span class="line">    md5_value &#x3D; __md5()</span><br><span class="line">    with open(filename, &#39;rb&#39;) as f:</span><br><span class="line">        while True:</span><br><span class="line">            data &#x3D; f.read(2048)</span><br><span class="line">            if not data:</span><br><span class="line">                break</span><br><span class="line">            md5_value.update(data)</span><br><span class="line">    return md5_value.hexdigest()</span><br><span class="line"></span><br><span class="line">def processing_a_single_cert(domain_name):</span><br><span class="line">    download_pem_filename &#x3D; cert_filename_template % (domain_name, &#39;pem.new&#39;)</span><br><span class="line">    download_key_filename &#x3D; cert_filename_template % (domain_name, &#39;key.new&#39;)</span><br><span class="line">    try:</span><br><span class="line">        urlretrieve(url % (domain_name, &#39;pem&#39;), filename &#x3D; download_pem_filename)</span><br><span class="line">        urlretrieve(url % (domain_name, &#39;key&#39;), filename &#x3D; download_key_filename)</span><br><span class="line">    except HTTPError:</span><br><span class="line">        log_file_write(&#39;%s download error !&#39; % domain_name)</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">    pem_filename &#x3D; cert_filename_template % (domain_name, &#39;pem&#39;)</span><br><span class="line">    key_filename &#x3D; cert_filename_template % (domain_name, &#39;key&#39;)</span><br><span class="line">    if __path(pem_filename).is_file() and __path(key_filename).is_file():</span><br><span class="line">        if md5sum(pem_filename) !&#x3D; md5sum(download_pem_filename) or md5sum(key_filename) !&#x3D; md5sum(download_key_filename):</span><br><span class="line">            remove(pem_filename)</span><br><span class="line">            remove(key_filename)</span><br><span class="line">            rename(download_pem_filename, pem_filename)</span><br><span class="line">            rename(download_key_filename, key_filename)</span><br><span class="line">            log_file_write(&#39;%s changed !&#39; % domain_name)</span><br><span class="line">            return True</span><br><span class="line">        else:</span><br><span class="line">            remove(download_pem_filename)</span><br><span class="line">            remove(download_key_filename)</span><br><span class="line">            log_file_write(&#39;%s no changed .&#39; % domain_name)</span><br><span class="line">            return False</span><br><span class="line">    else:</span><br><span class="line">        if __path(pem_filename).is_file():remove(pem_filename)</span><br><span class="line">        if __path(key_filename).is_file():remove(key_filename)</span><br><span class="line">        rename(download_pem_filename, pem_filename)</span><br><span class="line">        rename(download_key_filename, key_filename)</span><br><span class="line">        log_file_write(&#39;%s new cert !&#39; % domain_name)</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">def restart_server():</span><br><span class="line">    return  popen(restart_server_cmd).read().strip()</span><br><span class="line">    </span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    cert_path &#x3D; __path(cert_dir)</span><br><span class="line">    if cert_path.is_file(): remove(cert_dir)</span><br><span class="line">    if not cert_path.exists(): cert_path.mkdir()</span><br><span class="line">    if __path(list_filename).is_file():</span><br><span class="line">        is_reload &#x3D; False</span><br><span class="line">        with open(list_filename, &#39;r&#39;) as f:</span><br><span class="line">            for domain_name in f.readlines():</span><br><span class="line">                is_reload &#x3D; processing_a_single_cert(domain_name.strip())</span><br><span class="line">        if is_reload:</span><br><span class="line">            if return_str :&#x3D; restart_server() &#x3D;&#x3D; &#39;&#39;:</span><br><span class="line">                log_file_write(&#39;Apache reloaded !&#39;)</span><br><span class="line">            else:</span><br><span class="line">                log_file_write(&#39;Apache reloaded ! CMD return &#x3D; %s&#39; % return_str)</span><br><span class="line">        else:</span><br><span class="line">             log_file_write(&#39;Apache not reloaded .&#39;)</span><br><span class="line">    else:</span><br><span class="line">        log_file_write(&#39;%s not found !&#39; % list_filename)</span><br><span class="line"></span><br><span class="line">    if log_file !&#x3D; None and not log_file.closed:</span><br><span class="line">        log_file.close()</span><br></pre></td></tr></table></figure>这里需要注意的是：该脚本使用了海象运算符 := ，所以该脚本至少需要运行在 Python 3.8.0 上；目前 Ricky 使用的 Python 版本为 3.8.2 ，也是目前 Python 的最新版本。其中：1.  update_cert.list 是配置文件，里面存放的是要更新证书的域名的名称（一个域名一行，如：www.mydomain.com ）；这里用的是相对路径，所以该文件和 Python 脚本处在同一个目录下。2.  update_cert.log 是日志文件；这里用的是相对路径，所以该文件和 Python 脚本处在同一个目录下。3.  cert 是存放证书的目录，这里用的是相对路径，所以该目录和 Python 脚本处在同一个目录下。4.  C:\xampp\apache\bin\httpd -k restart 是重新加载 Apache 的命令，这个命令只是重新加载配置文件，不重启进程，具体如下图所示： [![](https://static.dingtalk.com/media/lAjPDeRESDyNiU7OP1PjT85A8N1C.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-12.png)-k restart : tell running Apache to do a graceful restartPython 脚本代码结构如下图所示：[![](https://static.dingtalk.com/media/lAjPDetfRYYaQx3OBn4W6c4CIWYw.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-9.png)Python 脚本代码结构##### **6 、将脚本添加到任务计划：****（ 1 ）将 Linux Shell 脚本 update_cert.sh 添加到 crontab 任务计划，并手工执行一次该脚本：**<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# echo &quot;51 3 * * * sh &#x2F;root&#x2F;update_cert.sh&quot; &gt;&gt; &#x2F;var&#x2F;spool&#x2F;cron&#x2F;root</span><br><span class="line">[root@host ~]# sh &#x2F;root&#x2F;update_cert.sh</span><br></pre></td></tr></table></figure>51 3 * * * 表示每天 3 点 51 分执行一次命令。不知道 crontab 怎么使用？请[点击这里](https://ccie.lol/knowledge-base/linux-centos-crontab-configuration/)。**（ 2 ）将 Python 脚本 update_cert.pyw 添加到 Windows 任务计划程序，并手工执行一次该脚本：**以 Windows Server 2012 R2 Datacenter 操作系统为例，先按 Windows 微标键 + R ，在弹出的窗口中输入 “taskschd.msc” ，然后点击 “ 确定 ” ，具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDe7sxCrfFqzOJ6KHLM5-C9IH.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-1.png)先按 Windows 微标键 + R ，在弹出的窗口中输入 “taskschd.msc” ，然后点击 “ 确定 ”接着会弹出一个名为 “任务计划程序” 的窗口，在窗口右边的侧边栏中点击 “ 创建基本任务 ” ，具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDefRxuFSIpvOSlV9085ys85c.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-2.png)接着会弹出一个名为 “任务计划程序” 的窗口，在窗口右边的侧边栏中点击 “ 创建基本任务 ”接着会弹出一个名为 “创建基本任务向导” 的窗口，在此处填写 “ 名称 ” 和 “ 描述 ” 后点击 “ 下一步 ” ，具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDetfRYYcAu3OLPiCVM48GNz9.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-3.png)接着会弹出一个名为 “创建基本任务向导” 的窗口，在此处填写 “ 名称 ” 和 “ 描述 ” 后点击 “ 下一步 ”接下来设置的是触发器，选择 “每天” 即可，然后点击 “ 下一步 ” ，具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDeC2yZfJLmXOYcHjO84b6z3V.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-4.png)接下来设置的是触发器，选择 “每天” 即可，然后点击 “ 下一步 ”接下来设置的是每日具体触发的时间，Ricky 这里设置的是凌晨 5 点 30 分触发，每隔 1 天发生一次，然后点击 “下一步” ，具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDfJ6Qs-lZDLOPilafM4LSgbS.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-5.png)接下来设置的是每日具体触发的时间，Ricky 这里设置的是凌晨 5 点 30 分触发，每隔 1 天发生一次，然后点击 “下一步”接下来设置的是操作，选择 “启动程序” 即可，然后点击 “ 下一步 ” ，具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDgCwPWLAhFLOA7OLG84ZkLl8.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-6.png)接下来设置的是操作，选择 “启动程序” 即可，然后点击 “ 下一步 ”接下来设置的是具体要启动哪些程序，具体参数设置如下所示，请根据实际需要做相应修改：*   程序或脚本需设置为 pythonw.exe 的绝对路径：“C:\Users\Administrator\AppData\Local\Programs\Python\Python38\pythonw.exe” ；*   添加参数（可选）需设置为 Python 脚本的名称：“update_cert.pyw” ；*   起始于（可选）需设置为 Python 脚本所在的目录：“E:\xampp\SSL” 。上述设置完成后请点击 “下一步” ，具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDfmVQBkz-SzOLaa2Os45KhK7.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-7.png)接下来设置的是具体要启动哪些程序，设置完成后请点击 “下一步”接下来没有什么是需要设置的，直接点击 “完成” 即可，具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDe7sxCrgmIrOBHPFE84TRz17.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-8.png)接下来没有什么是需要设置的，直接点击 “完成” 即可最后我们手工执行一次该脚本。其实您在 Python 的 IDLE 编辑器中跑一下脚本就可以了，那如何在 Windows 的 CMD 命令提示符窗口中运行该脚本呢？以 Windows Server 2012 R2 Datacenter 操作系统为例，先按 Windows 微标键 + R ，在弹出的窗口中输入 “cmd” ，然后点击 “ 确定 ” ，具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDfYHwXRwcLHONkiwA85kobjG.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-10.png)先按 Windows 微标键 + R ，在弹出的窗口中输入 “cmd” ，然后点击 “ 确定 ”接下来在弹出的窗口中输入以下三行命令即可：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;D E:</span><br><span class="line">cd E:\xampp\SSL</span><br><span class="line">C:\Users\Administrator\AppData\Local\Programs\Python\Python38\pythonw.exe update_cert.pyw</span><br></pre></td></tr></table></figure>具体如下图所示：[![](https://static.dingtalk.com/media/lAjPDfYHwXRsm1HOe-lCgM4DJJRr.file)](https://ccie.lol/wp-content/uploads/2020/03/linux-centos-use-acme-sh-11.png)接下来在弹出的窗口中输入这三行命令即可现在，证书就会同步到 2.2.2.2 和 3.3.3.3 上了！### **总结：**至此，acme.sh 脚本算是完美了。如果您没有使用集群，但是域名比较多，也可以使用上述方法来部署 acme.sh ，这样 acme.sh 只需要在一台服务器上安装即可（不用每台服务器都安装，方便统一管理）。]]></content>
      
      
      <categories>
          
          <category> centOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> https </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搬瓦工39刀年付GIA有货了</title>
      <link href="/2019/08/16/%E6%90%AC%E7%93%A6%E5%B7%A539%E5%88%80%E5%B9%B4%E4%BB%98GIA%E6%9C%89%E8%B4%A7%E4%BA%86/"/>
      <url>/2019/08/16/%E6%90%AC%E7%93%A6%E5%B7%A539%E5%88%80%E5%B9%B4%E4%BB%98GIA%E6%9C%89%E8%B4%A7%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<h1 id="CN2-GIA-限量版-年付-39-99-月流量300GB-放货了！"><a href="#CN2-GIA-限量版-年付-39-99-月流量300GB-放货了！" class="headerlink" title="CN2 GIA 限量版/年付$39.99/月流量300GB 放货了！"></a>CN2 GIA 限量版/年付$39.99/月流量300GB 放货了！</h1><ul><li>支持DC9机房</li><li>支持切换到CN2机房</li></ul><h3 id="购买链接"><a href="#购买链接" class="headerlink" title="购买链接"></a><a href="https://bwh88.net/aff.php?aff=51466&pid=71" target="_blank" rel="noopener">购买链接</a></h3>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
